---
import PageLayout from "@/layouts/Base.astro";
import { getCollection } from "astro:content";

const pubs = await getCollection("publication");
pubs.sort((a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime());

// group by year
const byYear = pubs.reduce((acc, p) => {
	const year = p.data.publishDate.getFullYear().toString();
	(acc[year] ??= []).push(p);
	return acc;
}, {} as Record<string, typeof pubs>);

const years = Object.keys(byYear).sort((a, b) => Number(b) - Number(a));
---

<PageLayout meta={{ title: "Publications" }}>
	<section class="mx-auto max-w-3xl">
		<h1 class="title mb-6">Publications</h1>

		{pubs.length === 0 ? (
			<div class="coming-soon">
				<div class="coming-soon-title">Coming Soon</div>
				<div class="coming-soon-subtext">
					Updates will appear here as soon as papers/preprints are public.
				</div>
			</div>
		) : (
			<div class="space-y-10">
				{years.map((year) => (
					<section>
						<h2 class="year">{year}</h2>
						<div class="space-y-6">
							{byYear[year].map((p) => (
								<article class="pub-card">
									{p.data.cover && (
										<img class="pub-cover" src={p.data.cover} alt={`${p.data.title} cover`} />
									)}

									<div class="pub-body">
										<a class="pub-title" href={p.data.primaryUrl} target="_blank" rel="noreferrer">
											{p.data.title}
										</a>

										{p.data.venue && <div class="pub-venue">{p.data.venue}</div>}
										{p.data.authors && <div class="pub-authors">{p.data.authors}</div>}

										{p.data.description && <div class="pub-desc">{p.data.description}</div>}

										<div class="pub-actions">
											{p.data.tags?.map((t) => (
												<span class="tag">{t}</span>
											))}
											{p.data.arxivUrl && (
												<a class="pill" href={p.data.arxivUrl} target="_blank" rel="noreferrer">
													arXiv
												</a>
											)}
											{p.data.pdfUrl && (
												<a class="pill" href={p.data.pdfUrl} target="_blank" rel="noreferrer">
													PDF
												</a>
											)}
											{p.data.githubUrl && (
												<a class="pill" href={p.data.githubUrl} target="_blank" rel="noreferrer">
													GitHub
												</a>
											)}
										</div>
									</div>
								</article>
							))}
						</div>
					</section>
				))}
			</div>
		)}
	</section>

	<style>
		.year {
			font-size: 1.5rem;
			font-weight: 700;
			margin: 0 0 1rem 0;
			color: var(--color-accent-2);
		}

		.pub-card {
			display: grid;
			grid-template-columns: 88px 1fr;
			gap: 1rem;
			padding: 1.25rem;
			border-radius: 12px;
			border: 1px solid rgba(255, 255, 255, 0.08);
			background: rgba(255, 255, 255, 0.03);
		}

		.pub-cover {
			width: 88px;
			height: 88px;
			border-radius: 10px;
			object-fit: cover;
			border: 1px solid rgba(255, 255, 255, 0.08);
		}

		.pub-title {
			display: inline-block;
			font-size: 1.1rem;
			font-weight: 700;
			line-height: 1.25;
			text-decoration: underline;
			text-decoration-color: rgba(255, 255, 255, 0.25);
			text-underline-offset: 3px;
		}
		.pub-title:hover {
			color: var(--color-accent);
			text-decoration-color: var(--color-accent);
		}

		.pub-venue {
			display: inline-block;
			margin-top: 0.5rem;
			padding: 0.2rem 0.55rem;
			border-radius: 999px;
			font-size: 0.75rem;
			font-weight: 600;
			background: rgba(34, 197, 94, 0.15);
			border: 1px solid rgba(34, 197, 94, 0.25);
		}

		.pub-authors {
			margin-top: 0.5rem;
			opacity: 0.75;
			font-size: 0.9rem;
		}

		.pub-desc {
			margin-top: 0.6rem;
			opacity: 0.85;
			font-size: 0.95rem;
			line-height: 1.55;
		}

		.pub-actions {
			margin-top: 0.9rem;
			display: flex;
			flex-wrap: wrap;
			gap: 0.5rem;
			align-items: center;
		}

		.tag {
			font-size: 0.7rem;
			padding: 0.22rem 0.55rem;
			border-radius: 999px;
			border: 1px solid rgba(255, 255, 255, 0.12);
			opacity: 0.85;
		}

		.pill {
			font-size: 0.7rem;
			padding: 0.22rem 0.55rem;
			border-radius: 999px;
			border: 1px solid var(--color-accent);
			color: var(--color-accent);
			text-decoration: none;
		}
		.pill:hover {
			background: var(--color-accent);
			color: white;
		}

		.coming-soon {
			margin-top: 3rem;
			padding: 3rem 1.5rem;
			border: 1px dashed rgba(255, 255, 255, 0.15);
			border-radius: 12px;
			text-align: center;
			opacity: 0.85;
		}
		.coming-soon-title {
			font-size: 1.25rem;
			font-weight: 700;
			letter-spacing: 0.08em;
			text-transform: uppercase;
			margin-bottom: 0.75rem;
			color: var(--color-accent);
		}
		.coming-soon-subtext {
			font-size: 0.95rem;
			line-height: 1.6;
			max-width: 32rem;
			margin: 0 auto;
		}

		@media (max-width: 480px) {
			.pub-card {
				grid-template-columns: 1fr;
			}
			.pub-cover {
				width: 100%;
				height: 160px;
			}
		}
	</style>
</PageLayout>