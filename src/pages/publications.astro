---
import PageLayout from "@/layouts/Base.astro";
import { getCollection } from "astro:content";

const pubs = await getCollection("publication");

// sort newest year first (and then title)
pubs.sort((a, b) => (b.data.year - a.data.year) || a.data.title.localeCompare(b.data.title));

// group by year
const byYear = pubs.reduce((acc, p) => {
  const y = p.data.year;
  (acc[y] ??= []).push(p);
  return acc;
}, {} as Record<number, typeof pubs>);

const years = Object.keys(byYear).map(Number).sort((a, b) => b - a);
---

<PageLayout meta={{ title: "Publications" }}>
  <section class="mx-auto w-full max-w-3xl">
    <h1 class="title mb-8">Publications</h1>

    {pubs.length === 0 ? (
      <div class="coming-soon">
        <div class="coming-title">Coming soon</div>
        <div class="coming-text">Preprint and published papers will be posted here</div>
      </div>
    ) : (
      years.map((year) => (
        <section class="year-block">
          <h2 class="year">{year}</h2>

          <div class="pub-list">
            {(byYear[year] ?? []).map((p) => (
              <div class="pub-card">
                {/* Entire card click goes to primary link */}
                <a class="pub-main" href={p.data.links.primary} target="_blank" rel="noreferrer">
                  {p.data.cover && (
                    <img class="pub-cover" src={p.data.cover} alt={`${p.data.title} cover`} loading="lazy" />
                  )}

                  <div class="pub-body">
                    <div class="pub-title">{p.data.title}</div>

                    {p.data.venue && <div class="badge">{p.data.venue}</div>}

                    {p.data.authors && <div class="pub-authors">{p.data.authors}</div>}

                    {p.data.description && <div class="pub-desc">{p.data.description}</div>}
                  </div>
                </a>

                {/* Optional buttons row (donâ€™t wrap these in the main <a>) */}
                <div class="pub-actions">
                  {p.data.tags?.slice(0, 3).map((t) => (
                    <span class="tag">{t}</span>
                  ))}

                  <div class="spacer" />

                  {p.data.links.arxiv && (
                    <a class="pill" href={p.data.links.arxiv} target="_blank" rel="noreferrer">arXiv</a>
                  )}
                  {p.data.links.pdf && (
                    <a class="pill" href={p.data.links.pdf} target="_blank" rel="noreferrer">PDF</a>
                  )}
                  {p.data.links.github && (
                    <a class="pill" href={p.data.links.github} target="_blank" rel="noreferrer">GitHub</a>
                  )}
                </div>
              </div>
            ))}
          </div>
        </section>
      ))
    )}
  </section>

  <style>
    .coming-soon{
      margin-top: 2rem;
      padding: 2.5rem 1.25rem;
      border: 1px dashed rgba(255,255,255,0.15);
      border-radius: 12px;
      text-align: center;
      opacity: 0.85;
    }
    .coming-title{
      color: var(--color-accent);
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      margin-bottom: 0.6rem;
    }
    .coming-text{ line-height: 1.6; }

    .year-block{ margin-top: 2rem; }
    .year{
      font-size: 1.5rem;
      font-weight: 700;
      margin: 1.25rem 0 0.75rem;
      color: var(--color-accent-2);
    }

    .pub-list{ display: grid; gap: 1rem; }

    .pub-card{
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 12px;
      overflow: hidden;
      background: rgba(255,255,255,0.02);
    }

    .pub-main{
      display: grid;
      grid-template-columns: 96px 1fr;
      gap: 1rem;
      padding: 1rem;
      text-decoration: none;
      color: inherit;
    }

    .pub-main:hover .pub-title{ text-decoration: underline; text-decoration-color: var(--color-accent); }

    .pub-cover{
      width: 96px;
      height: 72px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
    }

    .pub-title{
      font-size: 1.05rem;
      font-weight: 700;
      line-height: 1.35;
      margin-bottom: 0.4rem;
    }

    .badge{
      display: inline-block;
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      margin-bottom: 0.5rem;
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.10);
      color: var(--color-accent-2);
    }

    .pub-authors{
      opacity: 0.8;
      font-size: 0.9rem;
      margin-bottom: 0.35rem;
    }

    .pub-desc{
      opacity: 0.8;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .pub-actions{
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem 1rem;
    }

    .tag{
      font-size: 0.72rem;
      padding: 0.15rem 0.45rem;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.12);
      opacity: 0.9;
    }

    .spacer{ flex: 1; }

    .pill{
      font-size: 0.78rem;
      padding: 0.22rem 0.55rem;
      border-radius: 7px;
      border: 1px solid rgba(255,255,255,0.14);
      text-decoration: none;
      color: inherit;
      opacity: 0.9;
    }

    .pill:hover{
      border-color: var(--color-accent);
      color: var(--color-accent);
    }

    .pill-accent{
      border-color: var(--color-accent);
      color: var(--color-accent);
    }
  </style>
</PageLayout>